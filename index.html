<!DOCTYPE html>
<html type=en data-bs-theme="dark">
<head>
	<title>Netflow Explorer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
	<link rel="sytlesheet" type="text/css" href="dygraph.css" />
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
	<script type="text/javascript" src="dygraph.js"></script>
	<script type="text/javascript" src="flow_sort.js"></script>
	<script type="text/javascript" src="flows.js"></script>
	<script type="text/javascript" src="graphs.js"></script>
	<script type="text/javascript" src="ui.js"></script>

</head>
<body>
	<div class="container mt-2">
	<form>
		<div class="row">
		<div class="col-2">
			<label for="timetype" class="form-label">Type</label>
			<select type="input" class="form-select" id="timetype" aria-describedby="timetypehelp">
				<option value="relative" selected>Relative</option>
				<option value="range">Range</option>
			</select>
			<div id="timetypehelp" class="form-text">Type of time range</div>
		</div>
		<div class="col-6 d-none" id="relativetimeselect">
			<label for="relativetime" class="form-label">Time Frame</label>
			<div class="input-group">
				<input id="relativetime" type="text" class="form-control" value="5" aria-label="realitive time" aria-describedby="relativetimehelp">
				<ul id="relativetimedropdown" class="dropdown-menu dropdown-menu-end">
					<li><a class="dropdown-item" href="#" data-value="1">1 min</a></li>
					<li><a class="dropdown-item" href="#" data-value="5">5 min</a></li>
					<li><a class="dropdown-item" href="#" data-value="10">10 min</a></li>
					<li><a class="dropdown-item" href="#" data-value="30">30 min</a></li>
					<li><a class="dropdown-item" href="#" data-value="1h">1 hour</a></li>
					<li><a class="dropdown-item" href="#" data-value="12h">12 hour</a></li>
					<li><a class="dropdown-item" href="#" data-value="1d">1 day</a></li>
					<li><a class="dropdown-item" href="#" data-value="1w">1 week</a></li>
					<li><a class="dropdown-item" href="#" data-value="1m">1 month</a></li>
				</ul>
				<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"></button>
			</div>
			<div id="relativetimehelp" class="form-text">Select relative timeframe for flows</div>
		</div>
		<div class="col-6 d-none" id="rangetimeselect">
			<div class="row">
			<div class="col">
				<label for="startdate starttime" class="form-label">Start Time</label>
				<span class="input-group">
					<input type="date" id="startdate" class="text" class="form-control" aria-label="start date">
					<input type="time" id="starttime" class="text" class="form-control" aria-label="start time">
				</span>
			</div>
			<div class="col">
				<label for="enddate endtime" class="form-label">End Time</label>
				<span class="input-group">
					<input type="date" id="enddate" class="text" class="form-control" aria-label="end date">
					<input type="time" id="endtime" class="text" class="form-control" aria-label="end time">
				</span>
			</div>
			</div>
			<div id="rangetimehelp" class="form-text">Select start and end times for flows</div>
		</div>
		<div class="col-2">
			<label for="options" class="form-label">Options</label>
<!-- use button groups if more than one button -->
			<div class="input-group">
				<button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Fields</button>
				<ul id="fieldsdropdown" class="dropdown-menu">
				</ul>

			</div>
			<div id="optionshelp" class="form-text">Query options</div>
		</div>
		</div>
<!-- filter -->
		<div class="row">
		<div class="col-12">
			<label for="filter" class="form-label">Filter</label>
			<div class="input-group">
			<button type="button" class="btn btn-outline-secondary" data-bs-toggle="offcanvas" data-bs-target="#filterinfo" aria-controls="filter info help">
				<i class="bi bi-info-circle"></i>
			</button>
			<input class="form-control" id="filter" aria-describedby="filterhelp" placeholder="*">
			<button type="button" id="clearsearch" class="btn btn-outline-secondary">
				<i class="bi bi-x"></i>
			</button>
			<button type="button" id="flowsearch" class="btn btn-primary">
				<span role="status">Search</span>
				<span role="status" class="visually-hidden" aria-hidden="true">
					<span role="status" class="spinner-border spinner-border-sm" aria-hidden="true"></span>
					<span>Loading...</span>
				</span>
			</button>
			</div>
			<div id="filterstats" class="form-text fs-6">Enter filter the press Search</div>
		</div>
		</div>
	</form>
	</div>
	<div class="offcanvas offcanvas-end" style="width: 50%;" tabindex="-1" id="filterinfo" aria-labelledby="filterinfohelp">
		<div class="offcanvas-header">
			<h5 class="offcanvas-title" id="filterinfohelp">Filter Help</h5>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcavas-body" style="overflow: scroll;">
			<div class="m-2">
				<p>Flow records can be filtered using an expression made up of one or more expressions.
<pre>
   expression and expression
   expression or expression
   not expression and (expression)
</pre>
</p>
				<p> All expressions where a number is used, the number may be given in decimal, hex (by prefixing with 0x).  A multiplication factor may be used pre adding the suffix (K, M, G, T).
				</p>
				<p>When comparisons are required, one of the following can be used. If comp is omitted then 'equal' is assumed.
<pre>
	equal: EQ, = ==
	less than: LT, &lt;
	less than or equal: LE, &lt;=
	greater than: GT, &gt;
	greater than or equal: GE, &gt;=
</pre>
				</p>
			</div>
			<div class="row fs-4">
				<div class="col"> Syntax </div>
				<div class="col"> Description </div>
			</div>
			<div class="row">
				<div class="col">inet|ipv4|inet6|ipv6 </div>
				<div class="col">Select IPv4 or IPv6 packet types.</div>
			</div>
			<div class="row">
				<div class="col">proto &lt;name|number&gt; </div>
				<div class="col">Protocol to filter by.  Can specifiy wellknown name or number. </div>
			</div>
			<div class="row">
				<div class="col">[src|dst] net &lt;address[/bitmask]|address netmask&gt; </div>
				<div class="col">Network net|bit mask to search for. 'src' or 'dst' can be used to filter down to source or destination.</div>
			</div>
			<div class="row">
				<div class="col">[src|dst] ip &lt;address&gt; </div>
				<div class="col">Address to search for. 'src' or 'dst' can be used to filter down to source or destination.</div>
			</div>
			<div class="row">
				<div class="col">[src|dst] port &lt;number&gt; </div>
				<div class="col">Port to search for. 'src' or 'dst' can be used to filter down to source or destination.</div>
			</div>
			<div class="row">
				<div class="col">ttl &lt;comp&gt; &lt;number&gt; </div>
				<div class="col">Filter by TTL.</div>
			</div>
			<div class="row">
				<div class="col">router ip &lt;address&gt; </div>
				<div class="col">Address of flow agent. </div>
			</div>
			<div class="row">
				<div class="col">icmp [type|code] &lt;number&gt; </div>
				<div class="col">ICMP type or code number. </div>
			</div>
			<div class="row">
				<div class="col">tos &lt;number&gt; </div>
				<div class="col">Type Of Service field. </div>
			</div>
			<div class="row">
				<div class="col">[in|out] bytes &lt;comp&gt; &lt;number&gt; </div>
				<div class="col">Bytes in or out of flow. </div>
			</div>
			<div class="row">
				<div class="col">[in|out] packets &lt;comp&gt; &lt;number&gt; </div>
				<div class="col">Packets in or out of flow. </div>
			</div>
			<div class="row">
				<div class="col">[in|out] bps &lt;comp&gt; &lt;number&gt; </div>
				<div class="col">Bits per second in or out of flow. </div>
			</div>
			<div class="row">
				<div class="col">[in|out] bpp &lt;comp&gt; &lt;number&gt; </div>
				<div class="col">Bytes per second in or out of flow. </div>
			</div>
			<div class="row">
				<div class="col">[in|out] pps &lt;comp&gt; &lt;number&gt; </div>
				<div class="col">Packets per second in or out of flow. </div>
			</div>
		</div>
	</div>
	<hr>
<!-- graph -->
	<div class="accordion m-2" id="graphcontainer">
		<div class="accordion-item">
			<h2 class="accordion-header">
			<button id="graphbutton" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#graphdata" aria-expanded="false" aria-controls="graphdata">
				Graph&nbsp;&nbsp;&nbsp;
				<div class="fs-7 fw-lighter opacity-50">(zoom: click+drag; pan: shift+click+drag; restore: double-click)</div>
			</button>
			</h2>
			<div class="accordion-collapse collapse" id="graphdata" data-bs-parent="#graphcontainer">
				<div class="row p-0 m-2">
					<div class="col">
						<label for="graph-stack-type" class="form-label">Stack Type</label>
						<div class="input-group">
							<div class="btn-group" id="graph-stack-type" role="group" aria-label="graph-stack-type">
								<input type="radio" class="btn-check" id="ps1" name="graph-type" value="combined" autocomplete="off" checked>
								<label class="btn btn-outline-primary" for="ps1">Combined</label>
								<input type="radio" class="btn-check" id="ps2" name="graph-type" value="stacked" autocomplete="off">
								<label class="btn btn-outline-primary" for="ps2">Stacked</label>
							</div>
						</div>
					</div>
					<div class="col">
						<label for="graph-stack-by" class="form-label">Stack By</label>
						<div class="input-group">
							<div class="btn-group" role="group" id="graph-stack-by" aria-label="graph-stack-by">
								<button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
									Fields
								</button>
								<ul id="gsb-dropdown" class="dropdown-menu">
								</ul>
							</div>
						</div>
					</div>
					<div class="col-1">
						<label for="graph-top-n" class="form-label">Top N</label>
						<div class="input-group">
						<input type="text" class="form-control" id="graph-top-n" value="10" aria-label="graph-top-n">
						</div>
					</div>
				</div>
				<div class="row p-0 m-2">
					<div class="col p-0 m-0">
						<div class="" style="height: 300px;"  id="graphoutput"></div>
					</div>
				</div>
				<div class="row p-0 m-2">
					<div class="col-12">
						<div class="">Legend:&nbsp;&nbsp;<span id="graphlegend" class="fs-6">&nbsp;</span></div>
					</div>
				</div>
			</div>
		</div>
	</div>
<!-- flows -->
	<div class="accordion m-2" id="flowlistcontainer" data-sort-by="received" data-sort-dir="asc">
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button id="flowlistbutton" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flowlistdata" aria-expanded="false" aria-controls="flowlistdata"> Flows </button>
			</h2>
			<div class="accordion-collapse table-responsive collapse" id="flowlistdata" data-bs-parent="#flowlistcontainer">
				<nav class="navbar">
					<div class="w-100 mx-1">
						<div id="flowpager" class="btn-group w-25" role="group" aria-label="flow navigation buttons">
							<button type="button" class="btn btn-outline-secondary disabled"><i class="bi bi-chevron-bar-left"></i></button>
							<button type="button" class="btn btn-outline-secondary disabled"><i class="bi bi-chevron-left"></i></button>
							<input type="text" class="form-control" id="currentpage" value="0" disabled></button>
							<button type="button" class="btn btn-outline-secondary disabled"><i class="bi bi-chevron-right"></i></button>
							<button type="button" class="btn btn-outline-secondary disabled"><i class="bi bi-chevron-bar-right"></i></button>
						</div>
						<!--- dropdown to allow CSV download of flows -->
						<div class="btn-group float-end" role="group" aria-label="flow action buttons">
							<button id="flow-dropdown" type="button" class="btn btn-outline-secondary dropdown-toggle disabled" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-three-dots"></i></button>
							<ul id="flow-dropdown-list" class="dropdown-menu dropdown-menu-end">
								<li><a class="dropdown-item" href="#"><i class="bi bi-cloud-arrow-down"></i>&nbsp;Download</a></li>
								<li><a class="dropdown-item" href="#"><i class="bi bi-link"></i>&nbsp;Query Link</a></li>
							</ul>
						</div>
					</div>
				</nav>
				<table class="table font-monospace table-hover" id="flowlist">
					<thead class="mb-5"></thead>
					<tbody class="table-group-divider"></tbody>
				</table>
			</div>
		</div>
	</div>
<script>
const PROTO_NAMES = new Map([
	[ "1",		"ICMP"],
	[ "2",		"IGMP"],
	[ "6",		"TCP"],
	[ "17",		"UDP"],
	[ "47",		"GRE"],
	[ "50",		"ESP"],
	[ "51",		"AH"],
	[ "58",		"ICMP6"],
	[ "88",		"EIGRP"],
	[ "89",		"OSPF"],
	[ "103",	"PIM"],
	[ "112",	"VRRP"],
	[ "115",	"L2TP"],
	[ "123",	"PTP"],
	[ "124",	"ISIS"],
	[ "137",	"MPLS"],
	[ "240",	"PFSYNC"],
]);

const FLOW_FIELDS = new Map([
	[ "received", 	{ "desc": "Flow Received",	'checked': true , 'fil': undefined,		'sort': sort_received,	'stackby': false}],
	[ "duration", 	{ "desc": "Flow Duration",	'checked': false, 'fil': undefined,		'sort': sort_duration,	'stackby': false}],
	[ "proto", 		{ "desc": "Protocol",		'checked': true , 'fil': 'proto',		'sort': sort_proto, 	'stackby': true}],
	[ "srcAddr", 	{ "desc": "Source Address",	'checked': true , 'fil': 'src ip',		'sort': sort_srcAddr,	'stackby': true}],
	[ "srcPort", 	{ "desc": "Source Port",	'checked': true , 'fil': 'src port',	'sort': sort_srcPort,	'stackby': true}],
	[ "dstAddr", 	{ "desc": "Dest Address",	'checked': true , 'fil': 'dst ip',		'sort': sort_dstAddr,	'stackby': true}],
	[ "dstPort", 	{ "desc": "Dest Port", 		'checked': true , 'fil': 'dst port',	'sort': sort_dstPort,	'stackby': true}],
	[ "TTL", 		{ "desc": "TTL", 			'checked': false, 'fil': 'ttl',			'sort': sort_ttl,		'stackby': false}],
	[ "icmpTYpe", 	{ "desc": "ICMP Type", 		'checked': false, 'fil': 'icmp type',	'sort': sort_icmpTYpe,	'stackby': true}],
	[ "icmpCode", 	{ "desc": "ICMP Code", 		'checked': false, 'fil': 'icmp code',	'sort': sort_icmpCode,	'stackby': true}],
	[ "packets", 	{ "desc": "Packets", 		'checked': true , 'fil': 'packets eq',	'sort': sort_packets,	'stackby': false}],
	[ "bytes", 		{ "desc": "Bytes", 			'checked': true , 'fil': 'bytes eq',	'sort': sort_bytes,		'stackby': false}],
	[ "pps", 		{ "desc": "PPS", 			'checked': false, 'fil': 'pps eq',		'sort': sort_pps,		'stackby': false}],
	[ "bps", 		{ "desc": "BPS", 			'checked': false, 'fil': 'bps eq',		'sort': sort_bps,		'stackby': false}],
	[ "flags", 		{ "desc": "TCP Flags", 		'checked': false, 'fil': 'flags',		'sort': undefined,		'stackby': false}],
	[ "tos", 		{ "desc": "TOS", 			'checked': false, 'fil': 'tos',			'sort': sort_tos,		'stackby': false}],
	[ "routerIP", 	{ "desc": "Agent", 			'checked': false, 'fil': 'router ip',	'sort': sort_agent,		'stackby': true}],
]);

var cacheflows=undefined;
var cacheheaders=undefined;
var searchtime=undefined;
var dygraph=undefined;
var flowsperpage=50;

// Hookup stack-by selector
async function hookup_stack_by_selector() {
	const odd = document.getElementById("gsb-dropdown");
	var firstone = true;
	FLOW_FIELDS.keys().forEach( (f) => {
		if (FLOW_FIELDS.get(f).stackby == false) { return; }	// skip fields we don't want to try to stack
		var li = document.createElement("li");
		var di = document.createElement("div");
		di.classList.add('dropdown-item');
		di.classList.add('input-group-text');
		var fc = document.createElement("div");
		fc.classList.add('form-check');
		var cb = document.createElement("input");
		cb.classList.add('form-check-input');
		cb.setAttribute('type', 'radio');
		cb.setAttribute('name', 'graph-by');
		cb.setAttribute('id', 'gsb-'+f);
		cb.setAttribute('value', f);
		cb.setAttribute('aria-label', FLOW_FIELDS.get(f).desc);
		cb.checked = firstone;
		firstone = false;
		cb.addEventListener('click', (evt) => {
			// do not preventDefault() so that button checked changes
			build_graph();
		});
		var lb = document.createElement("label");
		lb.classList.add('form-check-label');
		lb.setAttribute('for', 'gsb-'+f);
		lb.innerHTML = FLOW_FIELDS.get(f).desc;
		// connect the elements
		fc.appendChild(cb);
		fc.appendChild(lb);
		di.appendChild(fc);
		li.appendChild(di);
		odd.appendChild(li);
	});
}
// Hookup fields selector
async function hookup_fields_selector() {
	const odd = document.getElementById("fieldsdropdown");
/*
<li>
	<div class="dropdown-item input-group-text">
	<div class="form-check">
	<input class="form-check-input" id="label1" type="checkbox" value="" aria-label="Checkbox for following text input">
	<label class="form-check-label" for="label1">checkbox description</label>
	</div>
	</div>
</li>
*/
	FLOW_FIELDS.keys().forEach( (f) => {
		var li = document.createElement("li");
		var di = document.createElement("div");
		di.classList.add('dropdown-item');
		di.classList.add('input-group-text');
		var fc = document.createElement("div");
		fc.classList.add('form-check');
		var cb = document.createElement("input");
		cb.classList.add('form-check-input');
		cb.setAttribute('type', 'checkbox');
		cb.setAttribute('id', 'fld-'+f);
		cb.setAttribute('value', f);
		cb.setAttribute('aria-label', FLOW_FIELDS.get(f).desc);
		cb.checked = FLOW_FIELDS.get(f).checked;
		cb.addEventListener('click', (evt) => {
			const current_page = document.getElementById('currentpage').value;
			load_headers();
			load_flows({'page': current_page });
		});
		var lb = document.createElement("label");
		lb.classList.add('form-check-label');
		lb.setAttribute('for', 'fld-'+f);
		lb.innerHTML = FLOW_FIELDS.get(f).desc;
		// connect the elements
		fc.appendChild(cb);
		fc.appendChild(lb);
		di.appendChild(fc);
		li.appendChild(di);
		odd.appendChild(li);
	});
}
// Hookup clear button
document.getElementById("clearsearch").addEventListener("click", btnElem => {
//	console.log('clear pressed');
	const filter = document.getElementById('filter');
	filter.value = "";
	if (typeof cacheflows !== 'undefined') {
		cacheflows.reset_filter();
	}
	load_flows();
	build_graph();
});
// Hookup search button
document.getElementById("flowsearch").addEventListener("click", btnElem => {
	console.log('search pressed');
	send_search();
});
// Hookup time type selector
document.getElementById("timetype").addEventListener("change", (evt) => {
	console.log('timetype changed');
	set_time_type()
});
// Hookup relative timeframe selector
document.querySelectorAll("#relativetimedropdown .dropdown-item").forEach((elem) => {
	elem.addEventListener("click", (evt) => {
		console.log('relative time selected');
		el = evt.target.dataset.value;
		reltime = document.getElementById("relativetime")
		reltime.value = el;
	});
});
// Hookup filter field key==Enter
document.getElementById('filter').addEventListener("keypress", (evt) => {
	if (evt.key === "Enter") {
		evt.preventDefault();
		send_search();
	}
});
// Hookup relative timeframe key==Enter
document.getElementById('relativetime').addEventListener("keypress", (evt) => {
	if (evt.key === "Enter") {
		evt.preventDefault();
		send_search();
	}
});
// Hookup Stack Type
document.getElementById('graph-stack-type').addEventListener("click", (evt) => {
	// do not preventDefault() so that button checked changes
	build_graph();
});
/* moved to hookup_stack_by_selector()
// Hookup Stack By
document.querySelectorAll('input[name="graph-by"]').forEach((f) => {
	f.addEventListener("click", (evt) => {
		// do not preventDefault() so that button checked changes
		build_graph();
	});
});
*/
// Hookup graph show signal
document.getElementById('graphcontainer').addEventListener('shown.bs.collapse', (evt) => {
	build_graph();
});
// Hookup graph-top-n
document.getElementById('graph-top-n').addEventListener('keypress', (evt) => {
	if (evt.key === "Enter") {
		evt.preventDefault();
		update_graph_top_n();
	}
});

// initialize the doc
window.addEventListener("load", () => {
	process_search_query();
	hookup_fields_selector();
	hookup_stack_by_selector();
	load_headers();
	// Hookup flow-dropdown-list
	var fdl = document.getElementById('flow-dropdown-list').querySelectorAll('a');
	fdl[0].addEventListener('click', (evt) => {
		evt.preventDefault();
		action_download_flows();
	});
	fdl[1].addEventListener('click', (evt) => {
		evt.preventDefault();
		action_copy_link();
	});
	set_time_type();
});

</script>
</body>
</html>
